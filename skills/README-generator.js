import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const AGENTSKILLS_DIR = path.resolve(__dirname, "agentskills");

function parseMetadata(content) {
  const match = content.match(/^---\n([\s\S]*?)\n---/);
  if (!match) return {};
  const metadata = {};
  match[1].split("\n").forEach(line => {
    const [key, ...v] = line.split(":");
    if (key && v.length > 0) metadata[key.trim()] = v.join(":").trim();
  });
  return metadata;
}

async function run() {
  if (!fs.existsSync(AGENTSKILLS_DIR)) return;
  fs.readdirSync(AGENTSKILLS_DIR).forEach(dir => {
    const p = path.join(AGENTSKILLS_DIR, dir);
    if (!fs.statSync(p).isDirectory()) return;
    const md = path.join(p, "SKILL.md");
    if (!fs.existsSync(md)) return;
    const meta = parseMetadata(fs.readFileSync(md, "utf-8"));
    const title = dir.split("-").map(w => w[0].toUpperCase() + w.slice(1)).join(" ");
    const content = [
      "# Skill: " + title,
      "",
      "> " + (meta.description || "No description"),
      "",
      "## Overview",
      "- Name: `" + (meta.name || dir) + "`",
      "- Spec: Agentskills.io v1.0",
      "",
      "## Usage",
      "Refer to [SKILL.md](./SKILL.md) for detailed instructions.",
      "",
      "---",
      "*Generated by Taonix*"
    ].join("\n");
    fs.writeFileSync(path.join(p, "README.md"), content);
    console.log("Generated " + dir + "/README.md");
  });
}
run().catch(console.error);
